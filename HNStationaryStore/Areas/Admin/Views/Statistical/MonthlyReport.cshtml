@model IEnumerable<HNStationaryStore.Models.MonthlyReportViewModel>
@{
    ViewBag.Title = "Báo cáo doanh thu theo tháng";
    Layout = "~/Areas/Admin/Views/Shared/_Layout.cshtml";
}

<div class="container-fluid">
    <a class="btn btn-success mb-3" href="/Admin/Statistical">Quay lại</a>
    <h1 class="h3 mb-2 text-gray-800">Báo cáo doanh thu theo tháng - Năm @ViewBag.SelectedYear</h1>
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                        Tổng doanh thu
                    </div>
                    <div class="h5 mb-0 font-weight-bold text-gray-800">
                        @string.Format("{0:N0}", Model.Sum(x => x.TotalRevenue)) đ
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                        Tổng lợi nhuận
                    </div>
                    <div class="h5 mb-0 font-weight-bold text-gray-800">
                        @string.Format("{0:N0}", Model.Sum(x => x.Profit)) đ
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <div class="row">
                <div class="col-md-6">
                    <h6 class="m-0 font-weight-bold text-primary">Doanh thu theo tháng</h6>
                </div>
                <div class="col-md-6 text-right">
                    @using (Html.BeginForm("MonthlyReport", "Statistical", new { area = "Admin" }, FormMethod.Get, new { id = "reportForm" }))
                    {
                        <div class="form-inline">
                            <label class="mr-2">Năm:</label>
                            @Html.DropDownList("year",
                                new SelectList(ViewBag.AvailableYears, ViewBag.SelectedYear),
                                new
                                     {
                                    @class = "form-control mr-2",
                                    id = "yearSelect"
                                })
                        </div>
                    }
                </div>
            </div>
            <div class="card-body">
                <div class="chart-area">
                    <canvas id="monthlyRevenueChart" height="300"></canvas>
                </div>
                <hr>
                <div class="table-responsive">
                    <table class="table table-bordered" width="100%" cellspacing="0">
                        <thead>
                            <tr>
                                <th>Tháng</th>
                                <th>Số đơn hàng</th>
                                <th>Doanh thu</th>
                                <th>Chi tiết</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in Model)
                            {
                                <tr>
                                    <td>Tháng @item.Month</td>
                                    <td>@item.OrderCount</td>
                                    <td>@string.Format("{0:N0}", item.TotalRevenue) đ</td>
                                    <td>
                                        <a href="@Url.Action("MonthlyOrders", "Statistical", new { area = "Admin", year = ViewBag.SelectedYear, month = item.Month })"
                                           class="btn btn-info btn-sm">
                                            <i class="fas fa-eye"></i> Xem chi tiết
                                        </a>
                                    </td>
                                </tr>
                            }
                        </tbody>
                        <tfoot>
                            <tr class="font-weight-bold">
                                <td>Tổng cộng</td>
                                <td>@Model.Sum(x => x.OrderCount)</td>
                                <td>@string.Format("{0:N0}", Model.Sum(x => x.TotalRevenue)) đ</td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

@section scripts {
    <script>

        // Submit form khi chọn năm
        document.getElementById('yearSelect').addEventListener('change', function () {
            document.getElementById('reportForm').submit();
        });

        // Monthly Revenue Chart
        var ctx = document.getElementById('monthlyRevenueChart');
        var monthlyRevenueChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: [@Html.Raw(string.Join(",", Model.Select(x => "'Tháng " + x.Month + "'")))],
                datasets: [{
                    label: 'Doanh thu',
                    data: [@string.Join(",", Model.Select(x => x.TotalRevenue))],
                    backgroundColor: 'rgba(78, 115, 223, 0.5)',
                    borderColor: 'rgba(78, 115, 223, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                maintainAspectRatio: false,
                scales: {
                    yAxes: [{
                        ticks: {
                            beginAtZero: true,
                            callback: function(value, index, values) {
                                return value.toLocaleString() + ' đ';
                            }
                        }
                    }]
                },
                tooltips: {
                    callbacks: {
                        label: function(tooltipItem, data) {
                            return tooltipItem.yLabel.toLocaleString() + ' đ';
                        }
                    }
                }
            }
        });
    </script>
}